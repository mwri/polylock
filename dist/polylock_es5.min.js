// Package: polylock v1.0.5 (built 2019-01-06 20:47:19)
// Copyright: (C) 2017 Michael Wright <mjw@methodanalysis.com>
// License: MIT

"use strict";!function(){var e=function(){var e=function(e){void 0===e&&(e={}),this.queue=new t,this.ex_locks={},this.ex_reserved={},this.sh_locks={},this.op_num=1,this.drain_for_writes=!!e.write_priority};e.prototype.exec=function(i,s){if(void 0===s&&(s={}),"function"!=typeof i)return Promise.reject(new Error("operation not a function"));var n=this.queue,h=this.op_num++,u=this;return new Promise(function(e,t){var o={op_fun:i,op_fff:e,op_rej:t,locks:s,op_num:h};n.push(o);var r=u.test_locks(s);0===r?u.run_queue():u.drain_for_writes&&4==(4&r)&&(u.reserve_locks(s),o.op_res=!0)}).then(function(e){return u.yield_locks(s),u.run_queue(),e})},e.prototype.wait=function(e){var t=this;return new Promise(function(o){t.exec(function(e,t){o(e)},e)})},e.prototype.test_locks=function(e){var t=Object.keys(e),o=t.length;if(0===o)return 0;for(var r=0,i=0,s=0,n=0;n<o;n++){var h=t[n];h in this.ex_locks&&0<this.ex_locks[h]&&(i=2),h in this.ex_reserved&&0<this.ex_reserved[h]&&(s=1),h in this.sh_locks&&0<this.sh_locks[h]&&"write"===e[h]&&(r=4)}return s|i|r},e.prototype.take_locks=function(e){if(1<this.test_locks(e))return!1;for(var t=Object.keys(e),o=t.length,r=0;r<o;r++){var i=t[r];"write"===e[i]?this.ex_locks[i]=i in this.ex_locks?this.ex_locks[i]+1:1:this.sh_locks[i]=i in this.sh_locks?this.sh_locks[i]+1:1}return!0},e.prototype.reserve_locks=function(e){for(var t=Object.keys(e),o=t.length,r=0;r<o;r++){var i=t[r];"write"===e[i]&&(this.ex_reserved[i]=i in this.ex_reserved?this.ex_reserved[i]+1:1)}},e.prototype.yield_reservations=function(e){for(var t=Object.keys(e),o=t.length,r=0;r<o;r++){var i=t[r];"write"===e[i]&&this.ex_reserved[i]--}},e.prototype.yield_locks=function(e){for(var t=Object.keys(e),o=t.length,r=0;r<o;r++){var i=t[r];"write"===e[i]?this.ex_locks[i]--:this.sh_locks[i]--}},e.prototype.run_queue=function(){for(var e=this.queue.head;void 0!==e;e=e.next){var t=e.data,o=this.test_locks(t.locks);(0===o||1===o&&t.op_res)&&(t.op_res&&this.yield_reservations(t.locks),this.take_locks(t.locks),0===t.op_fun.length?t.op_fff(t.op_fun()):t.op_fun(t.op_fff,t.op_rej),this.queue.remove(e))}};var t=function(){this.head=void 0,this.tail=void 0};return t.prototype.push=function(e){var t={data:e,prev:this.tail,next:void 0};return void 0===this.tail?this.head=t:this.tail.next=t,this.tail=t},t.prototype.remove=function(e){var t=e.prev,o=e.next;void 0===t?this.head=o:t.next=o,void 0===o?this.tail=t:o.prev=t},e}();"undefined"!=typeof module&&void 0!==module.exports?module.exports=e:window.polylock=e}();