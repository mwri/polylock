// Package: polylock v1.0.4 (built 2017-07-06 18:50:53)
// Copyright: (C) 2017 Michael Wright <mjw@methodanalysis.com>
// License: MIT

"use strict";!function(){var e=function(){var e=function(e){void 0===e&&(e={}),this.queue=new t,this.ex_locks={},this.ex_reserved={},this.sh_locks={},this.op_num=1,this.drain_for_writes=!!e.write_priority};e.prototype.exec=function(e,t){if(void 0===t&&(t={}),"function"!=typeof e)return Promise.reject(new Error("operation not a function"));var o=this.queue,r=this.op_num++,s=this;return new Promise(function(i,n){var h={op_fun:e,op_fff:i,op_rej:n,locks:t,op_num:r};o.push(h);var u=s.test_locks(t);0===u?s.run_queue():s.drain_for_writes&&4==(4&u)&&(s.reserve_locks(t),h.op_res=!0)}).then(function(e){return s.yield_locks(t),s.run_queue(),e})},e.prototype.test_locks=function(e){var t=Object.keys(e),o=t.length;if(0===o)return 0;for(var r=0,s=0,i=0,n=0;n<o;n++){var h=t[n];h in this.ex_locks&&this.ex_locks[h]>0&&(s=2),h in this.ex_reserved&&this.ex_reserved[h]>0&&(i=1),h in this.sh_locks&&this.sh_locks[h]>0&&"write"===e[h]&&(r=4)}return i|s|r},e.prototype.take_locks=function(e){if(this.test_locks(e)>1)return!1;for(var t=Object.keys(e),o=t.length,r=0;r<o;r++){var s=t[r];"write"===e[s]?this.ex_locks[s]=s in this.ex_locks?this.ex_locks[s]+1:1:this.sh_locks[s]=s in this.sh_locks?this.sh_locks[s]+1:1}return!0},e.prototype.reserve_locks=function(e){for(var t=Object.keys(e),o=t.length,r=0;r<o;r++){var s=t[r];"write"===e[s]&&(this.ex_reserved[s]=s in this.ex_reserved?this.ex_reserved[s]+1:1)}},e.prototype.yield_reservations=function(e){for(var t=Object.keys(e),o=t.length,r=0;r<o;r++){var s=t[r];"write"===e[s]&&this.ex_reserved[s]--}},e.prototype.yield_locks=function(e){for(var t=Object.keys(e),o=t.length,r=0;r<o;r++){var s=t[r];"write"===e[s]?this.ex_locks[s]--:this.sh_locks[s]--}},e.prototype.run_queue=function(){for(var e=this.queue.head;void 0!==e;e=e.next){var t=e.data,o=this.test_locks(t.locks);(0===o||1===o&&t.op_res)&&(t.op_res&&this.yield_reservations(t.locks),this.take_locks(t.locks),0===t.op_fun.length?t.op_fff(t.op_fun()):t.op_fun(t.op_fff,t.op_rej),this.queue.remove(e))}};var t=function(){this.head=void 0,this.tail=void 0};return t.prototype.push=function(e){var t={data:e,prev:this.tail,next:void 0};return void 0===this.tail?(this.head=t,this.tail=t):(this.tail.next=t,this.tail=t),t},t.prototype.remove=function(e){var t=e.prev,o=e.next;void 0===t?this.head=o:t.next=o,void 0===o?this.tail=t:o.prev=t},e}();"undefined"!=typeof module&&void 0!==module.exports?module.exports=e:window.polylock=e}();